name: Release

on:
  push:
    tags:
      - 'v*.*.*'

permissions:
  contents: write

jobs:
  build:
    name: Build and Release
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v5
        with:
          fetch-depth: 0
      
      - name: Set up Go
        uses: actions/setup-go@v6
        with:
          go-version: '1.25.3'
          cache: true
      
      - name: Run tests
        run: go test -v ./...
      
      - name: Build binaries
        run: |
          mkdir -p bin
          
          # Linux AMD64
          GOOS=linux GOARCH=amd64 go build -o bin/deep-thinking-agent-linux-amd64 \
            -ldflags="-X 'main.Version=${{ github.ref_name }}' -X 'main.BuildDate=$(date -u +%Y-%m-%dT%H:%M:%SZ)'" \
            ./cmd/cli
          
          # Linux ARM64
          GOOS=linux GOARCH=arm64 go build -o bin/deep-thinking-agent-linux-arm64 \
            -ldflags="-X 'main.Version=${{ github.ref_name }}' -X 'main.BuildDate=$(date -u +%Y-%m-%dT%H:%M:%SZ)'" \
            ./cmd/cli
          
          # macOS AMD64
          GOOS=darwin GOARCH=amd64 go build -o bin/deep-thinking-agent-darwin-amd64 \
            -ldflags="-X 'main.Version=${{ github.ref_name }}' -X 'main.BuildDate=$(date -u +%Y-%m-%dT%H:%M:%SZ)'" \
            ./cmd/cli
          
          # macOS ARM64 (Apple Silicon)
          GOOS=darwin GOARCH=arm64 go build -o bin/deep-thinking-agent-darwin-arm64 \
            -ldflags="-X 'main.Version=${{ github.ref_name }}' -X 'main.BuildDate=$(date -u +%Y-%m-%dT%H:%M:%SZ)'" \
            ./cmd/cli
          
          # Windows AMD64
          GOOS=windows GOARCH=amd64 go build -o bin/deep-thinking-agent-windows-amd64.exe \
            -ldflags="-X 'main.Version=${{ github.ref_name }}' -X 'main.BuildDate=$(date -u +%Y-%m-%dT%H:%M:%SZ)'" \
            ./cmd/cli
          
          # Create checksums
          cd bin
          sha256sum * > checksums.txt
          cd ..
      
      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          files: |
            bin/*
          generate_release_notes: true
          draft: false
          prerelease: ${{ contains(github.ref_name, '-rc') || contains(github.ref_name, '-beta') || contains(github.ref_name, '-alpha') }}
          body: |
            ## Installation
            
            Download the appropriate binary for your platform:
            
            ### Linux
            ```bash
            # AMD64
            wget https://github.com/gerrymiller/deep-thinking-agent/releases/download/${{ github.ref_name }}/deep-thinking-agent-linux-amd64
            chmod +x deep-thinking-agent-linux-amd64
            sudo mv deep-thinking-agent-linux-amd64 /usr/local/bin/deep-thinking-agent
            
            # ARM64
            wget https://github.com/gerrymiller/deep-thinking-agent/releases/download/${{ github.ref_name }}/deep-thinking-agent-linux-arm64
            chmod +x deep-thinking-agent-linux-arm64
            sudo mv deep-thinking-agent-linux-arm64 /usr/local/bin/deep-thinking-agent
            ```
            
            ### macOS
            ```bash
            # Intel (AMD64)
            wget https://github.com/gerrymiller/deep-thinking-agent/releases/download/${{ github.ref_name }}/deep-thinking-agent-darwin-amd64
            chmod +x deep-thinking-agent-darwin-amd64
            sudo mv deep-thinking-agent-darwin-amd64 /usr/local/bin/deep-thinking-agent
            
            # Apple Silicon (ARM64)
            wget https://github.com/gerrymiller/deep-thinking-agent/releases/download/${{ github.ref_name }}/deep-thinking-agent-darwin-arm64
            chmod +x deep-thinking-agent-darwin-arm64
            sudo mv deep-thinking-agent-darwin-arm64 /usr/local/bin/deep-thinking-agent
            ```
            
            ### Windows
            Download `deep-thinking-agent-windows-amd64.exe` and add to your PATH.
            
            ## Verify Checksums
            ```bash
            wget https://github.com/gerrymiller/deep-thinking-agent/releases/download/${{ github.ref_name }}/checksums.txt
            sha256sum -c checksums.txt
            ```
            
            ## What's Changed
            See the full changelog below.
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
